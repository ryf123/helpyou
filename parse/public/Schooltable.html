<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <!-- Bootstrap Core CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link href="vendors/bootstrap-table.min.css" rel="stylesheet">
		<link href="vendors/bootstrap-datepicker.min.css" rel="stylesheet">
        <link href="bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet">
        <!-- Latest compiled and minified js -->
        <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="vendors/bootstrap-table.min.js"></script>
        <script type="text/javascript" src="vendors/parse.js"></script>
        <script src="bootstrap-editable/js/bootstrap-editable.js"></script>
        <script src="bootstrap-editable/js/moment.min.js"></script>
        <script src="vendors/bootstrap-datepicker.js"></script>
    </head>
    <table id="table" data-show-footer="true" data-detail-view="true">
    </table>
    <script>
        // load initial data from database
        Parse.initialize("IMxHY4AEmtrLwyxSSrBx7fVdPAyCqUCIVczJZPWl","vT6GeGbec8Do6EZ3Wdny68iFFitjBGjus6ZOjpu0");
        Parse.Cloud.run('getobject', {objectname: "School"}, {
                        success: function(schooldata) {
                        var stringify_data = JSON.stringify(schooldata);
                        stringify_data = JSON.parse(stringify_data);
                        $('#table').bootstrapTable({
                           search : 'true',
                           data: stringify_data,
                           columns: [
                                     {
                                     width: '5%',
                                     field: 'schoolname',
                                     title: '学校名称',
                                     sortable:'true',
                                     footerFormatter: totalNameFormatter
                                     },
                                     {
                                     width: '7%',
                                     field: 'schooldistrict',
                                     title: '学区',
                                     sortable:'true'
                                     },
                                     {
                                     width: '5%',
                                     field: 'schooldismissaltime',
                                     title: '放学时间',
                                     sortable:'true',
                                     },
                                     {
                                     width: '5%',
                                     field: 'schooldismissaltimeerday',
                                     title: '放学时间（特殊）-星期',
                                     sortable:'true'
                                     },
                                     {
                                     width: '5%',
                                     field: 'schooldismissaltimeer',
                                     title: '放学时间（特殊）',
                                     sortable:'true'
                                     },
                                     {
                                     width: '40%',
                                     field: 'schoolerdate',
                                     title: '放学时间（特殊）-日期',
                                     sortable:'true',
                                     class: 'schoolerdate'
                                     },
                                     {
                                     width: '10%',
                                     field: 'schoolphonenumber',
                                     title: '学校联系电话',
                                     sortable:'true'
                                     },
                                     {
                                     width: '10%',
                                     field: 'operate',
                                     title: '保存',
                                     formatter:"operatesaveFormatter",
                                     events:"operateEvents"
                                     },
                                     ]
                           });
                        var tabledata = $('#table').bootstrapTable("getData");
                        // loop through tr elements
                        var i= 0;
                        $('#table tr').each(function(){
                            // the first row is table head, skip it
                            if(i != 0){
                            var registerdate = "";
                            var schoolerdate = $('#table').bootstrapTable("getData")[i-1]["schoolerdate"];
                            if(schoolerdate != undefined){
                            $(this).find(".schoolerdate")[0].innerHTML = schoolerdate;
                            }
                            }
                            i++;
                         });
						 $('#table .schoolerdate').datepicker({
                                                              startView: 1,
                                                              //startDate: "-1d",
                                                              //endDate: "+1y",
                                                              clearBtn: true,
                                                              multidate: true,
                                                              daysOfWeekDisabled: "0,6",
                        });
							$('#table .schoolerdate').datepicker()
								.on('changeDate', function(e){
									this.innerHTML = $(this).datepicker('getFormattedDate')
							});
                        // show the preselected date
                        $('#table .schoolerdate').datepicker()
                        .on('show', function(e){
                            var schoolerdatearray = this.innerHTML.split(",");
                            var datearray = [];
                            // if there is not date yet, then registerdate is undefined
                            if(schoolerdatearray[0] != "-"){
                            for (var i = 0; i < schoolerdatearray.length; i++){
                            datearray.push(new Date(schoolerdatearray[i]))
                            }
                            }
                            if(datearray.length != 0){
                            $(this).datepicker('setDate',datearray);
                            }
                            });
                  
                    },
                        error: function(error) {
                        alert("error");
                        }
        });
        // draw the save button
        function operatesaveFormatter(value, row, index) {
            return [
                    '<a class="save" href="javascript:void(0)" title="save">',
                    '<i class="glyphicon glyphicon-ok"></i>',
                    '</a>'
                    ].join('');
        }
        // draw the delete button
        function operateremoveFormatter(value, row, index) {
            return [
                    '<a class="remove ml10" href="javascript:void(0)" title="remove">',
                    '<i class="glyphicon glyphicon-remove"></i>',
                    '</a>'
                    ].join('');
        }
        // edit button event
        window.operateEvents = {
            
            
            
            // Edit/save button Event
            'click .save': function (e, value, row, index) {
                var objectid = row["objectId"];
                var schoolerdate = $(this).parent().parent().find(".schoolerdate").html();
                var myobjectvalue = {};
                myobjectvalue["schoolerdate"] = schoolerdate;
                Parse.Cloud.run('saveobject', { objectname: 'School', 'objectid':objectid,objectvalue:myobjectvalue}, {
                                success: function() {
                                console.log("Saved!");
                                },
                                error: function(error) {
                                alert("Can't save, try again");
                                }
                                });
                                
            },
        };
        // this is used to display "Total:"+ number
        function totalNameFormatter(data) {
            return "Total : "+data.length;
        }
    </script>
</html>
