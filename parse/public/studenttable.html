<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <!-- Bootstrap Core CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link href="vendors/bootstrap-table.min.css" rel="stylesheet">
        <link href="bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet">
        <!-- Latest compiled and minified js -->
        <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="vendors/bootstrap-table.min.js"></script>
        <script type="text/javascript" src="vendors/parse.js"></script>
        <script src="bootstrap-editable/js/bootstrap-editable.js"></script>
    </head>
    <table id="table" data-show-footer="true">
    </table>
    <script>
        // disable editable
        columnnamearray = ['studentid','age','firstname','lastname','grade','sex','contact','email','phonenumber','dob','edit','remove'];
        // load initial data from database
        Parse.initialize("IMxHY4AEmtrLwyxSSrBx7fVdPAyCqUCIVczJZPWl","vT6GeGbec8Do6EZ3Wdny68iFFitjBGjus6ZOjpu0");
        Parse.Cloud.run('getstudent', {}, {
                        success: function(schooldata) {
                        var stringify_data = JSON.stringify(schooldata);
                        stringify_data = JSON.parse(stringify_data);
                        $('#table').bootstrapTable({
                           search : 'true',
                           data: stringify_data,
                           columns: [
                                     {
                                         field: 'studentid',
                                         title: '学号',
                                         sortable:'true',
                                         footerFormatter: totalNameFormatter
                                     },
                                     {
                                         field: 'age',
                                         title: '年龄',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'firstname',
                                         title: '名',
                                         sortable:'true',
                                     },
                                     {
                                         field: 'lastname',
                                         title: '姓',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'grade',
                                         title: '年级',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'sex',
                                         title: '性别',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'contact',
                                         title: '联系人',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'email',
                                         title: '邮箱',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'phonenumber',
                                         title: '联系电话',
                                         sortable:'true'
                                     },
                                     {
                                         field: 'dob',
                                         sortable:'true',
                                         title: '生日'
                                     },
                                     {
                                         field: 'edit',
                                         formatter: 'operateeditFormatter',
                                         events : 'operateEvents'
                                     },
                                     {
                                         field: 'remove',
                                         formatter: 'operateremoveFormatter',
                                         events : 'operateEvents'
                                     },
                                     ]
                           });
                        },
                        error: function(error) {
                        alert("error");
                        }
        });
        // draw the edit button
        // if "UpdateCell" is called, then initBody will be called
        // the initBody() function in bootstrap-table will call this to update icon
        // if the current icon is
        function operateeditFormatter(value, row, index) {
        // get the edit icon
        var icon  = $("#table tr").eq(index+1).find("td a i").first()
        //if current icon is ok then do not change
        if(icon != undefined){
            if(icon.attr("class") =="glyphicon glyphicon-ok"){
                return [
                        '<a class="edit" href="javascript:void(0)" title="edit">',
                        '<i class="glyphicon glyphicon-ok"></i>',
                        '</a>'
                        ].join('');
            }
        }
        return [
                '<a class="edit" href="javascript:void(0)" title="edit">',
                '<i class="glyphicon glyphicon-edit"></i>',
                '</a>'
                ].join('');
        }
        // draw the delete button
        function operateremoveFormatter(value, row, index) {
            return [
                    '<a class="remove ml10" href="javascript:void(0)" title="remove">',
                    '<i class="glyphicon glyphicon-remove"></i>',
                    '</a>'
                    ].join('');
        }
        // edit button event
        window.operateEvents = {
            
            
            // Edit/save button Event
            
            'click .edit': function (e, value, row, index) {
                var button = "#table tr[data-index='"+index+"'] td .edit i";
                var trindex = "#table tr[data-index='"+index+"'] td";
                $(trindex).slice( 2, -2 ).editable('toggleDisabled'); // toggle disable
                //if ok button is clicked
                if($(button).attr("class") == "glyphicon glyphicon-ok"){
                    $(button).attr("class","glyphicon glyphicon-edit");
                    // run cloud code to save the object
                    var myobjectid = row["objectId"];
                    Parse.Cloud.run('saveobject', { objectname: 'Student', objectvalue:row,objectid:myobjectid}, {
                        success: function() {
                                    alert("保存成功!");
                        },
                        error: function(error) {
                                    alert("Can't save, try again");
                        }
                    });
                }
                else{
                    // if it's the first time, then editable does not exist
                    // then enable the edit
                    if($(trindex).slice( 2,-2).hasClass("editable-disabled") == true){
                        $(trindex).slice( 2, -2 ).editable('toggleDisabled');
                    }
                    $(button).attr("class","glyphicon glyphicon-ok");
                // do not selec the last two items which are edit and remove
                $(trindex).slice( 2, -2 ).editable({
                    title: 'enter name',
                    mode: 'inline'
                });
                console.log(value, row, index);
                // on save event, if the value is saved then update row value
                // save mean the the tick icon, or "enter" is pressed∂up
                $(trindex).slice( 2, -2 ).on('save', function(e, params) {
                     rowindex = $(this).parent()[0].rowIndex-1;
                     colindex = this.cellIndex;
                     fieldname = columnnamearray[colindex];
                     $('#table').bootstrapTable("updateCell",{rowIndex: rowindex, fieldName: fieldname, fieldValue: params.newValue});
                     //update cell will disable editable, re-enable it
                     $('#table tr').each(function(){
                         icon = $(this).find("td a i").first();
                         if(icon.attr("class") =="glyphicon glyphicon-ok"){
                             $(this).find("td").slice(2,-2).editable();
                         }
                     })
                });
                }
            },
            
            
            //Remove button Event
            
            'click .remove': function (e, value, row, index) {
                if (confirm("确定要删除吗？") == true) {
                    var myobjectid = row["objectId"];
                    var studentid = row["studentid"];
                    Parse.Cloud.run('deleteobject', { objectname: 'Student',objectid:myobjectid}, {
                                    success: function() {
                                    $('#table').bootstrapTable('remove', {field: 'studentid',values: [studentid]});
                                    console.log("Delete!");
                                    },
                                    error: function(error) {
                                    alert("Delete failed");
                        }
                    });
                }
            }
        };
        // this is used to display "Total:"+ number
        function totalNameFormatter(data) {
            return "Total : "+data.length;
        }
    </script>
</html>
