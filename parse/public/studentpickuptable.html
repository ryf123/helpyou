<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
            
        <title>HYACSIS-Pickup Schedule</title>
        
        <!-- Bootstrap -->
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!-- MetisMenu CSS -->
        <link href="metisMenu/metisMenu.min.css" rel="stylesheet">
        <!-- Custom CSS -->
        <link href="vendors/sb-admin-2.css" rel="stylesheet">
        <!-- Custom Fonts -->
        <link href="vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="vendors/select2.min.css" rel="stylesheet">
        <link href='vendors/application.css' rel='stylesheet'>
        <link href="vendors/app.css" rel="stylesheet" type="text/css"/>
</head>
<body class="nav-md" style="padding-top: 0px">
    <div id="wrapper">
        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                    <div class="row">
                        <div class="col-lg-1">
                            <img src="hyaclogo.png" class="img-circle" alt="Cinque Terre" width="25" height="25">
                        </div>
                        <div class="col-lg-11">
                            HelpYouAchieve Student Information System
                        </div>
                    </div>
                    </a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-envelope fa-fw"></i><span class="badge"></span>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-messages" id="messages">
                        <li>
                            <a class="text-center" href="hotlinenotification.html">
                                <strong>Read All Messages</strong><i class="fa fa-angle-right"></i>
                            </a>
                        </li>
                    </ul>
                </li>
                <!-- /.dropdown-messages -->
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href='#' id="signoutbutton"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                </li>
                <!-- /.dropdown-user -->
            </ul>
            <!-- /.navbar-top-links -->
            
            <div class="navbar-default sidebar" role="navigation" style="width: 220px; margin-top: 51px;">
                <div class="sidebar-nav navbar-collapse" style="width: 220px;">
                    <ul class="nav" id="side-menu">
                        <li><a href="index.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-dashboard fa-fw"></i> Dashboard / 首页</a></li>
                        <li><a href="hotlinenotification.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-envelope fa-fw"></i> Hotline / 出勤热线</a></li>
                        <!-- / Info inputs-->
                        <li>
                            <a href="#" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-edit fa-fw"></i> Info Inputs / 信息录入<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li><a href="districtform.html" style="padding-left: 32px;">District Inputs / 学区信息</a></li>
                                <li><a href="schoolform.html" style="padding-left: 32px;">School Inputs / 学校信息</a></li>
                                <li><a href="Studentform.html" style="padding-left: 32px;">Student Inputs / 学生信息</a></li>
                                <li><a href="Registrationinput.html" style="padding-left: 32px; padding-right: 0px;">Registration Inputs / 注册信息</a></li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <!-- /End of 1st - Info inputs-->
                        <li><a href="districtform.html" style="padding-left: 10px; padding-right: 10px;">
                            <i class="fa fa-home fa-fw"></i> District / 学区</a></li>
                        <li><a href="schooltable.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-hospital-o fa-fw"></i> School / 学校</a></li>
                        <li><a href="studenttable.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-users fa-fw"></i> Student / 学生</a></li>
                        <li><a href="Registrationinput.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-pencil fa-fw"></i> Registration / 注册</a></li>
                        <li><a href="studentpickuptable.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-th-list fa-fw"></i> Pickup Schedule / 接送安排</a></li>
                        <li><a href="studentsignintable.html" style="padding-left: 10px; padding-right: 10px;">
                                <i class="fa fa-check-square-o fa-fw"></i> Student Sign In / 学生签到</a></li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>
        <!--End of Heading-->
        <div id="page-wrapper" style="min-height: 260px;margin-left: 220px;boder-left-width: 0px;">
            <div class="row">
                <br>
                <div class="col-lg-1" style="padding-right: 0px; width:">
                    <img src="hyaclogo.png" class="img-circle" alt="Cinque Terre" width="55" height="55">
                </div>
                <div class="col-lg-11">
                    <h3 class="text-primary" style="margin-top: 10px">HYACSIS - Students Pickup Schedule</h3>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.End of 1st row -System Name -->
            <hr>
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-info">
                        <div class="panel-heading" style="padding-left: 30px;">请将左栏中学校拖拽入右栏相应老师名下，形成排班表。 <br> Please drag the Schools from the left column to the right column under each teacher to create the pickup schedule.                        
                        </div>
                        <div class="panel-body">
                            <div class="row-fluid" >
                                <div class="container" id="printable">
                                    <div data-force="30" class="layer block" style="left: 14.5%; top: 80px; width: 30%;">
                                        <ul id="teacherlist" class="block__list block__list_words">
                                            <li>Tang</li>
                                            <li>Koji</li>
                                            <li>Wu</li>
                                            <li>Yang</li>
                                            <li>Yan</li>
                                            <li>Lu</li>
                                        </ul>
                                    </div>

                                    <div data-force="30" class="layer block" style="left: 50%; top: 80px; width: 30%;">
                                        <ul id="studentlist" class="block__list block__list_words">
                                        </ul>
                                    </div>

                                </div>
                                <!-- Save Button -->
                                <div class="col-lg-4" style="left: 90%; top: 100px; width: 30%;">
                                    <span class="pull-left">
                                    <button type="button" class="btn btn-outline btn-success" id="save">Save / 保存</button>
                                    </span>                                
                                </div>
                                <!-- End of Save Button -->
                                <!-- end of container -->
                            </div>
                        </div>
                    </div>
                    <!-- End of Panel -->
                </div>
            </div>
            <!-- End of 2nd row         -->
        </div>
        <!-- End of page-wrapper -->
    </div>
    <!-- End of wrapper -->

    <!-- footer content -->
    <footer>
        <div class="">
            <p class="pull-right">Copyright ©2015 Evereast All Rights Reserved |
            <span class="lead"> <i class="fa fa-paw"></i> Evereast</span>
            </p>
        </div>
    </footer>
    <!-- /footer content -->    

    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="metisMenu/metisMenu.min.js"></script>
    <!-- Custom Theme JavaScript -->
    <script src="vendors/sb-admin-2.js"></script>
    <!-- momentjs -->
    <script src="bootstrap-editable/js/moment.min.js"></script>
    <script src="vendors/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="vendors/parse.js"></script>
    <script src="vendors/select2.min.js"></script>
    
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
     <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
     <![endif]-->
    <script src="vendors/modernizr-2.6.2-respond-1.1.0.min.js"></script>
    
    <script src="vendors/application.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="metisMenu/metisMenu.min.js"></script>
    <script src="vendors/Sortable.js"></script>
    <script src="vendors/jspdf.min.js"></script>
    
    <script>
    // initialize constant
    var d = new Date();
    var currentyear = d.getFullYear();
    var currentmonth = d.getMonth()+1;
    var currentday = d.getDate();
    var currentyearmonth = currentyear +""+currentmonth;
    var registeryearmonth = "register"+currentyearmonth;
    var todaystriing = currentmonth+"/"+currentday+"/"+currentyear;
    var dayofweek = d.getDay();
    $(function(){
        // save button on click convert to pdf
        $("#save").click(function(){
            margins = {
                top: 40,
                bottom: 40,
                left: 40,
                right: 40,
                width: 522
            };
            var doc = new jsPDF();
            source = $('#printable')[0],
            doc.fromHTML(
                source,
                margins.left,
                margins.top,
                {
                    'width': margins.width 
                },
                function (dispose) {
                    doc.save('Test.pdf');
                },
                margins
            );
        });
        var teacherlist = $("#teacherlist")[0];
        var studentlist = $("#studentlist")[0];
        Sortable.create(teacherlist,{
            group: "connected",
            animation: 100
        });
        Sortable.create(studentlist,{
            group: "connected",
            animation: 100
        });
        Parse.initialize("IMxHY4AEmtrLwyxSSrBx7fVdPAyCqUCIVczJZPWl","vT6GeGbec8Do6EZ3Wdny68iFFitjBGjus6ZOjpu0");
        Parse.Cloud.run('getobject', {objectname: 'School'}, {
        success: function(schools) {
                schools = JSON.parse(JSON.stringify(schools));
                getStudent(schools);


                
          },
            error: function(error) {
                console.log(error);
           }
        });
    });
    function getStudent(schools){
        var schools =  convertdatatokeyvalue(schools,"schoolname"); // school can be accessed by name
        var schoolsource = {}; // this will used to store students and school, the structure is {school1:{time1:{student},time2:{student},time3:studnet},school2:{time1:{student}},schooln:{time1:{student},timen:{student}}}
        // initialize schoolsource
        Object.keys(schools).forEach(function (key) {
            schoolsource[key] = {};
        });
        Parse.Cloud.run('getobject', {objectname: 'Student'}, {
        success: function(students) {
                students = JSON.parse(JSON.stringify(students));
                // step0 if today is saturday or sunday which is 0 or 6, if it is, then skip
                if(dayofweek != 0 && dayofweek !=6){
                    for(j in students){
                        var currentstudent = students[j];
                        var myschool = currentstudent["school"];
                            var grade = currentstudent["grade"];
                            var tempdate = currentstudent["tempdate"];
                            var temploc = currentstudent["temploc"];
                            var temptime = currentstudent["temptime"];
                            // step1 if student is registered today, if not registered then continue
                            if(studentisregistered(currentstudent) == false){
                                continue;
                            }
                            // step 1.1 if the stduent has temp/special date/time loc set
                            // igonore the normal grade just use temp/speical daet/time/loc
                            if(tempdate != undefined && temploc != undefined && temptime != undefined){
                                if(tempdate.indexOf(todaystriing) > -1){
                                    temptime = converttime(temptime);
                                    schoolsource = pushstudenttoschoolsource(schoolsource,temptime,temploc,currentstudent);
                                    continue;
                                }
                            } 
                            // step2 if student grade is TK K or something else
                        
                            if(grade == "TK"){
                                // step 2.1 if shcool has TKscheduleoption set to 1, then push the student to schoolsource[time]
                                if(schools[myschool]["TKscheduleoption"] == 1){
                                TKDismissalTime = schools[myschool]["TKDismissalTime"];
                                if(TKDismissalTime != undefined){
                        
                                    TKDismissalTime = converttime(TKDismissalTime);
                                    schoolsource = pushstudenttoschoolsource(schoolsource,TKDismissalTime,myschool,currentstudent);
                                    continue;
                                }
                                }
                            }
                            if(grade == "K"){
                                // step 2.2 if shcool has TKscheduleoption set to 1, then push the student to schoolsource[time]
                                if(schools[myschool]["Kscheduleoption"] == 1){
                                    // step 2.2.1 is today Kintroductorydays, whether today in in range of between start and end
                                    var Kintroductorydaysend = schools[myschool]["Kintroductorydaysend"];
                                    var Kintroductorydaysstart = schools[myschool]["Kintroductorydaysstart"];
                                    if(Kintroductorydaysstart != undefined && Kintroductorydaysend != undefined){
                                        var startDate = new Date(Kintroductorydaysstart);
                                        var endDate = new Date(Kintroductorydaysend);
                                        if(d >= startDate && d<=endDate){
                                            KIDSDismissalTime = converttime(schools[myschool]["KIDSDismissalTime"]);
                                            schoolsource = pushstudenttoschoolsource(schoolsource,KIDSDismissalTime,myschool,currentstudent);
                                            continue;
                                        }
                                    }
                                    // step 2.2.2 is today KtbdDismissalTimedate? actual date
                                    var KtbdDismissalTimedate = schools[myschool]["KtbdDismissalTimedate"];
                                    if(KtbdDismissalTimedate != undefined){
                                        if(KtbdDismissalTimedate.indexOf(todaystriing)){
                                            KtbdDismissalTime = converttime(schools[myschool]["KtbdDismissalTime"]);
                                            schoolsource = pushstudenttoschoolsource(schoolsource,KtbdDismissalTime,myschool,currentstudent);
                                            continue;
                                    }
                                    }
                                    // step 2.2.3 is today KtbdDTWD? day of week
                                    var KtbdDTWD = schools[myschool]["KtbdDTWD"];
                                    if(KtbdDTWD != undefined){
                                        if(dayofweek == KtbdDTWD){
                                            var KtbdDismissalTime = converttime(schools[myschool]["KtbdDismissalTime"]);
                                            schoolsource = pushstudenttoschoolsource(schoolsource,KtbdDismissalTime,myschool,currentstudent);
                                            continue;
                                        }
                                    }
                                    // step 2.2.4 grade is K; and Kscheduleoption is set; and it does not fall into above categories
                                    var KrDismissalTime = converttime(schools[myschool]["KrDismissalTime"]);
                                    if(KrDismissalTime != undefined){
                                        KrDismissalTime = converttime(KrDismissalTime);
                                        schoolsource = pushstudenttoschoolsource(schoolsource,KrDismissalTime,myschool,currentstudent);
                                        continue;
                                    }
                                }
                            }// end of grade==K
                            // everything else, which is "grade is not TK scheduleoption set, or grade is not K schedule option not set or anything else"
                            // step3 is today GtbdDismissalTimedate?
                            var GtbdDismissalTimedate = schools[myschool]["GtbdDismissalTimedate"];
                            if(GtbdDismissalTimedate.indexOf(todaystriing) != -1){
                                var GtbdDismissalTime = converttime(schools[myschool]["GtbdDismissalTime"]);
                                schoolsource = pushstudenttoschoolsource(schoolsource,GtbdDismissalTime,myschool,currentstudent);
                                continue;
                            }
                            // step4 is today GtbdDTWD?
                            var GtbdDTWD = schools[myschool]["GtbdDTWD"];
                            if(dayofweek == GtbdDTWD){
                                var GtbdDismissalTime = converttime(schools[myschool]["GtbdDismissalTime"]);
                                schoolsource = pushstudenttoschoolsource(schoolsource,GtbdDismissalTime,myschool,currentstudent);
                                continue;
                            }
                            else{
                                var GrDismissalTime = converttime(schools[myschool]["GrDismissalTime"]);
                                schoolsource = pushstudenttoschoolsource(schoolsource,GrDismissalTime,myschool,currentstudent);
                                continue;
                            }
                        } //end of student loop
                    } // end of dayofweek!=0/6
                    
                        Object.keys(schoolsource).forEach(function (schoolname) {
                      var currentschool = schoolsource[schoolname];
                      Object.keys(currentschool).forEach(function (schooldismissaltime) {
                         var studentarray = currentschool[schooldismissaltime];
                         var studentnumber = studentarray.length;
                         // change time style to 10:30 PM style
                         schooldismissaltime = schooldismissaltime.replace("time_", "");
                         schooldismissaltime = schooldismissaltime.replace("_", ":");
                         schooldismissaltime = schooldismissaltime.replace("PM", " PM");
                         schooldismissaltime = schooldismissaltime.replace("AM", " AM");

                         schoolinfo = "<li><div>"+"<i class='fa fa-clock-o'></i>"+schooldismissaltime+"——"+ schoolname +"——"+studentnumber+"</div></li>";
                         //$(".schools").append(schoolinfo);
                         $("#studentlist").append("<li>"+ schooldismissaltime+"——"+ schoolname +"——"+studentnumber +"</li>");
                       });
                      });
                    
                }, // end of success
            error: function(error) {
                console.log(error);
                return [];
           }
        });

        if(Parse.User.current() == undefined){
            $(location).attr('href','login.html');
        }
        
        Parse.Cloud.run('getobjectwithkeyequal',{objectname:"Smsmessage",keyname:"read",stringval:"false"},{
            success: function(msgs){
                msgs = JSON.parse(JSON.stringify(msgs));
                for(index in msgs){
                    var msg = msgs[index];
                    console.log(msg);
                    mbody = msg["mbody"];
                    mfrom = msg["mfrom"];
                    msginfo = "<li><a href ='#'><div><strong>"+mfrom+"</strong></div><div>"+mbody+"</div></a></li><li class='divider'></li>";
                    $("#messages").append(msginfo);        
                }
                //change badge number
                $(".badge")[0].innerText = msgs.length;
            },
            error: function(error){
                console.log(error);
            }
        });
      $('#signoutbutton').click(function() {
        Parse.User.logOut();
        $(location).attr('href','login.html');
      }); 
    }
    
    // this function converts data
    // input [{name:school1,city:NY,time:11:00},{name:school2,city:LA,time:12:00}]
    // output {school1:{name:school1,city:NY,time:11:00},school2:{name:school2,city:LA,time:12:00}}
    // this the value can be accessed by data["school1"]["city"]
    // the data must have newkey in it
    function convertdatatokeyvalue(data,newkey){
        var converted = {}
        for(index in data){
            var temp = data[index];
            var name = temp[newkey];
            if(name != undefined){
                converted[name] = temp;
            }
        }
        return converted;
    }
    
    //whether the student is registered today
    // return true if it's registered else return false
    function studentisregistered(student){
        if(student[registeryearmonth] != undefined){
            if(student[registeryearmonth].indexOf(todaystriing) != -1){
                return true;// if the register date contains today
            }
        }
        return false;
    }
    
    // function insert student to school source and return school source
    // if the time: key is not created, then create it
    function pushstudenttoschoolsource(schoolsource,schooltimestring,schoolname,currentstudent){
        var currentstudentarray = undefined;
        if(schoolsource[schoolname]  == undefined){
            schoolsource[schoolname] = {};
        }
        else{
            currentstudentarray = schoolsource[schoolname][schooltimestring];
        }
        if(currentstudentarray ==  undefined){
            schoolsource[schoolname][schooltimestring] = [currentstudent];
        }
        else{
            currentstudentarray.push(currentstudent);
            schoolsource[schoolname][schooltimestring] = currentstudentarray;
        }
        return schoolsource;
    }
    // convert time from 2:05 PM to time_2_05_PM
    function converttime(time){
        if(time == undefined){
            return undefined;
        }
        converted = time.replace(/\s/g, ""); // replace whitespace
        converted = converted.replace(/:/g, "_"); // replace whitespace
        return "time_"+converted;
    }
    </script>
</body>
<style>
.navbar-default {
    background-color: #d9edf7;
    border-color: #bce8f1;
}
.sidebar ul li a.active {
  background-color: #d9edf7;
}
.nav>li>a:focus, .nav>li>a:hover{
  text-decoration: none;
  background-color: #fff;
}
.sidebar ul li a.active {
  background-color: #fff;
}
.navbar-default .navbar-brand {
  color: #337ab7;
}
.panel-footer {
  background-color: #fff;
  border-top: 1px solid #fff;
}
body {
    background-color: #d9edf7;
}
.form-control {
  border: 1px solid #bce8f1;
}
.btn-default {
  color: #337ab7;
  background-color: #fff;
  border-color: #bce8f1;
}
body {
  color: #337ab7;
}
</style>
</html>